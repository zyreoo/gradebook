<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alocări Profesori - <%= school.name %></title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><%= school.name %> - Alocări Profesori</h1>
            <div class="user-info">
                <p><strong>Nume:</strong> <%= user.name %></p>
                <p><strong>Email:</strong> <%= user.email %></p>
                <p><strong>Rol:</strong> Administrator Școală</p>
            </div>
        </div>

        <!-- Navigation -->
        <div class="section-nav-admin">
            <a href="/admin/dashboard">Panou</a>
            <a href="/admin/subjects">Materii</a>
            <a href="/admin/classes">Clase</a>
            <a href="/admin/add-user">Adaugă Utilizator</a>
            <a href="/admin/teacher-assignments" class="active">Alocări Profesori</a>
            <a href="/admin/people">Persoane</a>
        </div>

        <!-- Messages -->
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message"><%= error %></div>
        <% } %>
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="success-message"><%= success %></div>
        <% } %>

        <!-- Teacher Assignments Section -->
        <section class="section">
            <h2>Alocări Profesori</h2>
            <p class="helper" style="margin-bottom: 16px;">Alocă profesori la clase. Materiile disponibile pentru fiecare clasă provin de la profesorii alocați.</p>

            <% const teacherClasses = typeof allClasses !== 'undefined' ? allClasses : (school.classes || []); %>
            <% const classYearTeachers = school.classYearTeachers || {}; %>
            
            <% if (teacherClasses.length === 0) { %>
                <div class="muted-box">Nicio clasă definită încă. Te rog adaugă clase în secțiunea Clase sau alocă profesori pentru a crea clase automat.</div>
            <% } else { %>
                <div class="filter" style="margin-bottom: 16px;">
                    <label for="class-search">Caută clase:</label>
                    <input type="text" id="class-search" placeholder="Caută după numele clasei..." oninput="filterClasses()" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;">
                </div>
                <div class="class-accordion-list" id="class-accordion-list">
                    <% teacherClasses.forEach(function(cls) { %>
                        <div class="class-accordion-card" data-class-name="<%= cls.toLowerCase() %>">
                            <div class="class-accordion-header" onclick="toggleClassDetails('<%= cls %>')">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span class="class-accordion-icon" id="icon-<%= cls %>">▼</span>
                                    <strong style="font-size: 16px;">Clasa <%= cls %></strong>
                                </div>
                                <span class="badge"><%= (classYearTeachers[cls] || []).length %> profesor(i)</span>
                            </div>
                            <div class="class-accordion-details" id="details-<%= cls %>" style="display: none;">
                            
                            <% 
                                const assignedTeacherIds = classYearTeachers[cls] || [];
                                const assignedTeachers = teachers.filter(t => assignedTeacherIds.includes(t.uid));
                            %>
                            
                            <!-- Classmaster Assignment -->
                            <% 
                                const classMasters = school.classMasters || {};
                                const currentClassmasterId = classMasters[cls] || classMasters[cls.toUpperCase()] || classMasters[cls.toLowerCase()];
                                const currentClassmaster = currentClassmasterId ? teachers.find(t => t.uid === currentClassmasterId) : null;
                            %>
                            <div class="person" style="margin-bottom: 14px;">
                                <div>
                                    <strong style="font-size: 14px; display: block; margin-bottom: 8px;">Diriginte:</strong>
                                    <% if (currentClassmaster) { %>
                                        <div>
                                            <strong><%= currentClassmaster.name %></strong>
                                            <small><%= currentClassmaster.email %></small>
                                        </div>
                                    <% } else { %>
                                        <small class="helper">Niciun diriginte alocat</small>
                                    <% } %>
                                </div>
                                <% if (currentClassmaster) { %>
                                    <form action="/admin/remove-classmaster" method="POST" style="margin: 0;">
                                        <input type="hidden" name="className" value="<%= cls %>">
                                        <button type="submit" class="btn-remove">Elimină</button>
                                    </form>
                                <% } else { %>
                                    <form action="/admin/assign-classmaster" method="POST" style="display: flex; gap: 8px; align-items: center; margin: 0;">
                                        <input type="hidden" name="className" value="<%= cls %>">
                                        <select name="teacherId" required style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;">
                                            <option value="">Selectează Profesor</option>
                                            <% if (assignedTeachers.length > 0) { %>
                                                <% assignedTeachers.forEach(function(t) { %>
                                                    <option value="<%= t.uid %>"><%= t.name %></option>
                                                <% }); %>
                                            <% } else { %>
                                                <% teachers.forEach(function(t) { %>
                                                    <option value="<%= t.uid %>"><%= t.name %></option>
                                                <% }); %>
                                            <% } %>
                                        </select>
                                        <button type="submit" class="btn-primary">Alocă</button>
                                    </form>
                                <% } %>
                            </div>

                            <% 
                                const availableTeachers = teachers.filter(t => !assignedTeacherIds.includes(t.uid));
                            %>

                        <% if (assignedTeachers.length > 0) { %>
                            <div class="people-list" style="margin-bottom: 14px;">
                                <% assignedTeachers.forEach(function(teacher) { %>
                                        <% 
                                            const teacherAllSubjects = teacher.subjects || (teacher.subject ? [teacher.subject] : []);
                                            const assignment = school.teacherAssignments && school.teacherAssignments[cls] && school.teacherAssignments[cls][teacher.uid];
                                            const assignedSubjects = assignment && assignment.subjects ? assignment.subjects : teacherAllSubjects;
                                        %>
                                    <div class="person">
                                        <div>
                                            <strong><%= teacher.name %></strong>
                                            <small>
                                                <% if (assignedSubjects.length > 0) { %>
                                                    Predă: <%= assignedSubjects.join(', ') %>
                                                <% } else { %>
                                                    Nicio materie pentru această clasă
                                                <% } %>
                                            </small>
                                        </div>
                                            <form action="/admin/remove-teacher-assignment" method="POST" style="margin: 0;">
                                                <input type="hidden" name="classYear" value="<%= cls %>">
                                                <input type="hidden" name="teacherId" value="<%= teacher.uid %>">
                                                <button type="submit" class="btn-remove">Elimină</button>
                                            </form>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <p class="helper" style="margin-bottom: 14px;">Niciun profesor alocat încă.</p>
                        <% } %> 

                            <% if (availableTeachers.length > 0) { %>
                                <div class="batch-assignment-container" id="batch-assignment-<%= cls %>">
                                    <div class="teacher-selection-list">
                                        <% availableTeachers.forEach(function(teacher) { %>
                                            <% 
                                                const teacherSubjects = teacher.subjects || (teacher.subject ? [teacher.subject] : []);
                                            %>
                                            <div class="teacher-assignment-card" data-teacher-id="<%= teacher.uid %>">
                                                <label class="teacher-card-header">
                                                    <input type="checkbox" 
                                                           class="teacher-select-checkbox" 
                                                           value="<%= teacher.uid %>"
                                                           data-year="<%= cls %>"
                                                           data-subjects='<%= JSON.stringify(teacherSubjects) %>'
                                                           onchange="toggleTeacherSubjects('<%= cls %>', '<%= teacher.uid %>')">
                                                <div class="teacher-info">
                                                    <strong><%= teacher.name %></strong>
                                                    <small><%= teacher.email %></small>
                                                    <% if (teacherSubjects.length > 0) { %>
                                                        <small style="color: var(--accent); margin-top: 2px;">
                                                            Cunoaște: <%= teacherSubjects.join(', ') %>
                                                        </small>
                                                    <% } %>
                                                </div>
                                            </label>
                                            
                                                    <!-- Subject selection (shown when teacher checkbox is checked) -->
                                                    <div id="subjects-<%= cls %>-<%= teacher.uid %>" 
                                                         class="subject-selection-inline" 
                                                         style="display: none;">
                                                        <% if (teacherSubjects.length > 0) { %>
                                                            <div class="inline-subjects">
                                                                <% teacherSubjects.forEach(function(subject) { %>
                                                                    <label class="subject-pill">
                                                                        <input type="checkbox" 
                                                                               class="subject-checkbox"
                                                                               data-teacher-id="<%= teacher.uid %>"
                                                                               data-year="<%= cls %>"
                                                                               value="<%= subject %>" 
                                                                               checked>
                                                                        <span><%= subject %></span>
                                                                    </label>
                                                                <% }); %>
                                                            </div>
                                                        <% } else { %>
                                                            <small class="helper">Nicio materie alocată acestui profesor</small>
                                                        <% } %>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        </div>
                                        
                                        <button type="button" 
                                                class="btn-primary" 
                                                style="margin-top: 16px; width: 100%;"
                                                onclick="assignSelectedTeachers('<%= cls %>')"
                                                id="assign-btn-<%= cls %>"
                                                disabled>
                                            Alocă Profesorii Selectați
                                        </button>
                                    </div>
                                <% } else { %>
                                    <p class="helper">Toți profesorii au fost alocați acestei clase.</p>
                                <% } %>

                            <!-- Show derived subjects -->
                            <% 
                                const derivedSubjects = [...new Set(assignedTeachers.flatMap(t => {
                                    const subjects = t.subjects || (t.subject ? [t.subject] : []);
                                    return subjects;
                                }))];
                            %>
                            <% if (derivedSubjects.length > 0) { %>
                                <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border);">
                                    <small class="helper" style="font-weight: 600;">Materii disponibile:</small>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
                                        <% derivedSubjects.forEach(function(subject) { %>
                                            <span class="badge"><%= subject %></span>
                                        <% }); %>   
                                    </div>
                                </div>
                            <% } %>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } %>
        </section>

        <!-- Footer -->
        <div class="dashboard-footer">
            <form action="/auth/logout" method="GET">
                <button type="submit" class="btn-primary">Deconectare</button>
            </form>
        </div>
    </div>

    <script>
        async function handleFormSubmit(event, form) {
            event.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton?.textContent;
            const originalDisabled = submitButton?.disabled;
            
            if (submitButton) {
                submitButton.disabled = true;
            }

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    alert(`❌ Eroare: ${result.error || 'Operațiunea a eșuat'}`);
                    if (submitButton) {
                        submitButton.disabled = originalDisabled;
                        if (originalText) submitButton.textContent = originalText;
                    }
                }
            } catch (error) {
                console.error('Form submission error:', error);
                alert('❌ A apărut o eroare. Te rog încearcă din nou.');
                if (submitButton) {
                    submitButton.disabled = originalDisabled;
                    if (originalText) submitButton.textContent = originalText;
                }
            }
        }

        function toggleClassDetails(className) {
            const details = document.getElementById(`details-${className}`);
            const icon = document.getElementById(`icon-${className}`);
            const card = icon.closest('.class-accordion-card');
            
            if (!details || !icon || !card) return;
            
            const isExpanded = details.style.display !== 'none';
            
            if (isExpanded) {
                details.style.display = 'none';
                icon.textContent = '▼';
                card.classList.remove('expanded');
            } else {
                details.style.display = 'block';
                icon.textContent = '▲';
                card.classList.add('expanded');
            }
        }

        function filterClasses() {
            const searchTerm = (document.getElementById('class-search').value || '').toLowerCase().trim();
            const classCards = document.querySelectorAll('.class-accordion-card');
            let visibleCount = 0;
            
            classCards.forEach(card => {
                const className = card.getAttribute('data-class-name') || '';
                
                if (searchTerm === '' || className.includes(searchTerm)) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            const accordionList = document.getElementById('class-accordion-list');
            let noResultsMsg = document.getElementById('no-classes-filtered');
            
            if (visibleCount === 0 && searchTerm !== '') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('p');
                    noResultsMsg.id = 'no-classes-filtered';
                    noResultsMsg.className = 'helper';
                    noResultsMsg.style.marginTop = '16px';
                    noResultsMsg.textContent = 'No classes match your search.';
                    accordionList.parentNode.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        function toggleTeacherSubjects(year, teacherId) {
            const checkbox = document.querySelector(
                `input.teacher-select-checkbox[value="${teacherId}"][data-year="${year}"]`
            );
            const subjectsDiv = document.getElementById(`subjects-${year}-${teacherId}`);
            
            if (checkbox && checkbox.checked) {
                subjectsDiv.style.display = 'block';
                subjectsDiv.querySelectorAll('input.subject-checkbox').forEach(cb => {
                    cb.checked = true;
                });
            } else if (subjectsDiv) {
                subjectsDiv.style.display = 'none';
            }
            
            updateAssignButton(year);
        }

        async function assignSelectedTeachers(year) {
            const checkboxes = document.querySelectorAll(
                `input.teacher-select-checkbox[data-year="${year}"]:checked`
            );
            
            if (checkboxes.length === 0) {
                return;
            }
            
            const assignBtn = document.getElementById(`assign-btn-${year}`);
            const originalText = assignBtn.textContent;
            assignBtn.disabled = true;
            assignBtn.textContent = 'Assigning...';
            let successCount = 0;
            let errorCount = 0;
            
            for (const checkbox of checkboxes) {
                const teacherId = checkbox.value;
                const selectedSubjects = Array.from(
                    document.querySelectorAll(
                        `#subjects-${year}-${teacherId} input.subject-checkbox:checked`
                    )
                ).map(cb => cb.value);
                
                if (selectedSubjects.length === 0) {
                    errorCount++;
                    continue;
                }
                
                try {
                    const response = await fetch('/admin/assign-teacher-ajax', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            classYear: year, 
                            teacherId: teacherId, 
                            subjects: selectedSubjects 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Error assigning teacher:', error);
                    errorCount++;
                }
            }
            
            assignBtn.disabled = false;
            assignBtn.textContent = originalText;
            
            if (successCount > 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 800);
            } else if (errorCount > 0) {
                console.error(`Failed to assign ${errorCount} teacher(s)`);
            }
        }

        function updateAssignButton(year) {
            const checkboxes = document.querySelectorAll(
                `input.teacher-select-checkbox[data-year="${year}"]:checked`
            );
            const assignBtn = document.getElementById(`assign-btn-${year}`);
            
            if (assignBtn) {
                if (checkboxes.length > 0) {
                    assignBtn.disabled = false;
                    assignBtn.textContent = `Assign ${checkboxes.length} Selected Teacher(s)`;
                } else {
                    assignBtn.disabled = true;
                    assignBtn.textContent = 'Assign Selected Teachers';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('form[action="/admin/assign-classmaster"]').forEach(form => {
                form.addEventListener('submit', (e) => handleFormSubmit(e, form));
            });

            document.querySelectorAll('form[action="/admin/remove-classmaster"]').forEach(form => {
                form.addEventListener('submit', (e) => handleFormSubmit(e, form));
            });

            document.querySelectorAll('form[action="/admin/remove-teacher-assignment"]').forEach(form => {
                form.addEventListener('submit', (e) => handleFormSubmit(e, form));
            });
            
            ['9', '10', '11', '12'].forEach(year => {
                updateAssignButton(year);
            });
        });
    </script>
</body>
</html>
