<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - <%= school.name %></title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
                    <h1><%= school.name %></h1>
            <div class="user-info">
                <p><strong>Name:</strong> <%= user.name %></p>
                <p><strong>Email:</strong> <%= user.email %></p>
                <p><strong>Role:</strong> School Administrator</p>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="section">
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-value"><%= teachers.length %></div>
                    <div class="stat-label">Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><%= students.length %></div>
                    <div class="stat-label">Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><%= (school.subjects || []).length %></div>
                    <div class="stat-label">Subjects</div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message"><%= error %></div>
        <% } %>
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="success-message"><%= success %></div>
        <% } %>

        <!-- Navigation -->
        <div class="section-nav-admin">
            <a href="#subjects">Subjects</a>
            <a href="#classes">Classes</a>
            <a href="#add-user">Add User</a>
            <a href="#teacher-assignments">Teacher Assignments</a>
            <a href="#people">People</a>
        </div>

        <!-- Subject Library Section -->
        <section id="subjects" class="section">
            <h2>Subject Library</h2>
            <p class="helper" style="margin-bottom: 16px;">Keep your catalog tidy. Remove unused subjects or add new ones.</p>

            <% if (school.subjects && school.subjects.length > 0) { %>
                <div class="pill-rail">
                    <% school.subjects.forEach(function(subject) { %>
                        <div class="pill"> 
                            <span><%= subject %></span>
                            <button type="button" onclick="confirmRemoveSubject('<%= subject %>')" aria-label="Remove <%= subject %>">×</button>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="muted-box">No subjects yet. Add your first one below.</div>
            <% } %>

            <form action="/admin/add-subject" method="POST" onsubmit="return validateSubjectForm()" style="margin-top: 18px;">
                <div class="form-grid">
                    <div class="field">
                        <label for="subjectName">Add a subject</label>
                        <input id="subjectName" name="subjectName" type="text" placeholder="e.g., Mathematics, Chemistry" maxlength="50" required>
                    </div>
                    <div class="field" style="align-self: flex-end;">
                        <button class="btn-primary" type="submit">Add Subject</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Classes Section -->
        <section id="classes" class="section">
            <h2>Classes</h2>
            <p class="helper" style="margin-bottom: 16px;">All classes in your school. Classes are automatically created when teachers are assigned, or you can add them manually below.</p>

            <% const allClassesList = typeof allClasses !== 'undefined' ? allClasses : []; %>
            <% const explicitClasses = (school.classes || []); %>

            <% if (allClassesList.length > 0) { %>
                <div class="pill-rail">
                    <% allClassesList.forEach(function(cls) { 
                        const isExplicit = explicitClasses.includes(cls);
                        const teacherCount = (school.classYearTeachers && school.classYearTeachers[cls]) ? school.classYearTeachers[cls].length : 0;
                    %>
                        <div class="pill"<% if (!isExplicit) { %> style="border-style: dashed;"<% } %>> 
                            <span><%= cls %></span>
                            <% if (teacherCount > 0) { %>
                                <span style="font-size: 11px; color: var(--text-dim); margin: 0 4px;">(<%= teacherCount %> teacher<%= teacherCount !== 1 ? 's' : '' %>)</span>
                            <% } %>
                            <% if (isExplicit) { %>
                                <form action="/admin/remove-class" method="POST" style="display:inline; margin:0;">
                                    <input type="hidden" name="className" value="<%= cls %>">
                                    <button type="submit" aria-label="Remove <%= cls %>" style="background:none; border:none; color:inherit; cursor:pointer; padding:0; margin-left:8px;">×</button>
                                </form>
                            <% } else { %>
                                <span style="font-size: 11px; color: var(--text-dim); margin-left: 4px;" title="This class was created through teacher assignments">(auto)</span>
                                <form action="/admin/remove-class" method="POST" style="display:inline; margin:0;">
                                    <input type="hidden" name="className" value="<%= cls %>">
                                    <button type="submit" aria-label="Remove <%= cls %>" style="background:none; border:none; color:inherit; cursor:pointer; padding:0; margin-left:8px;">×</button>
                                </form>
                            <% } %>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="muted-box">No classes yet. Add your first one below or assign a teacher to a class.</div>
            <% } %>

            <form action="/admin/add-class" method="POST" style="margin-top: 18px;">
                <div class="form-grid">
                    <div class="field">
                        <label for="className">Add a class</label>
                        <input id="className" name="className" type="text" placeholder="e.g., 9A, 9B, 10C" maxlength="20" required>
                    </div>
                    <div class="field" style="align-self: flex-end;">
                        <button class="btn-primary" type="submit">Add Class</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Create User Section -->
        <section id="add-user" class="section">
            <h2>Create a User</h2>
            <p class="helper" style="margin-bottom: 16px;">Add teachers or students and set the right fields in one pass.</p>
            
            <form action="/admin/create-user" method="POST">
                <div class="form-grid">
                    <div class="field">
                        <label for="name">Full name</label>
                        <input id="name" name="name" type="text" placeholder="Jane Smith" autocomplete="name" required>
                    </div>
                    <div class="field">
                        <label for="email">Email</label>
                        <input id="email" name="email" type="email" placeholder="jane.smith@school.edu" autocomplete="email" required>
                    </div>
                    <div class="field">
                        <label for="password">Password</label>
                        <input id="password" name="password" type="password" minlength="6" placeholder="Minimum 6 characters" autocomplete="new-password" required>
                    </div>
                    <div class="field">
                        <label for="confirmPassword">Confirm password</label>
                        <input id="confirmPassword" name="confirmPassword" type="password" minlength="6" placeholder="Re-enter password" autocomplete="new-password" required>
                    </div>
                    <div class="field">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="">Select role</option>
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                        </select>
                    </div>
                    <div class="field" id="classYearGroup" style="display: none;">
                        <label for="classYear">Class</label>
                        <select id="classYear" name="classYear">
                            <option value="">Select class</option>
                            <% (typeof allClasses !== 'undefined' ? allClasses : (school.classes || [])).forEach(function(cls) { %>
                                <option value="<%= cls %>"><%= cls %></option>
                            <% }); %>
                        </select>
                        <% 
                            const availableClasses = typeof allClasses !== 'undefined' ? allClasses : (school.classes || []);
                            if (availableClasses.length === 0) { 
                        %>
                            <small class="helper" style="color: #dc3545;">No classes defined. Please add classes in the Classes section or assign teachers to create classes automatically.</small>
                        <% } %>
                    </div>
                    <div class="field" id="parentEmailGroup" style="display: none;">
                        <label for="parentEmail">Parent Email (Optional)</label>
                        <input id="parentEmail" name="parentEmail" type="email" placeholder="parent@example.com" autocomplete="email">
                        <small class="helper">Parent account will be created automatically</small>
                    </div>
                    <div class="field" id="parentPasswordGroup" style="display: none;">
                        <label for="parentPassword">Parent Password (Optional)</label>
                        <input id="parentPassword" name="parentPassword" type="password" minlength="6" placeholder="Minimum 6 characters" autocomplete="new-password">
                        <small class="helper">Required if parent email is provided</small>
                    </div>
                    <div class="field" id="subjectGroup" style="display: none;">
                        <label for="subject">Subjects</label>
                        <select id="subject" name="subjects" multiple style="min-height: 120px;">
                            <% if (school.subjects && school.subjects.length > 0) { %>
                                <% school.subjects.forEach(function(subject) { %>
                                    <option value="<%= subject %>"><%= subject %></option>
                                <% }); %>
                            <% } %>
                        </select>
                        <small class="helper">Hold Ctrl/Cmd to select multiple subjects</small>
                    </div>
                </div>
                <div style="margin-top: 14px;">
                    <button class="btn-primary" type="submit">Create User</button>
                </div>
            </form>
        </section>

        <!-- Teacher Assignments Section -->
        <section id="teacher-assignments" class="section">
                    <h2>Teacher Assignments</h2>
            <p class="helper" style="margin-bottom: 16px;">Assign teachers to classes. Each class's available subjects come from its assigned teachers.</p>

            <% const teacherClasses = typeof allClasses !== 'undefined' ? allClasses : (school.classes || []); %>
            <% const classYearTeachers = school.classYearTeachers || {}; %>
            
            <% if (teacherClasses.length === 0) { %>
                <div class="muted-box">No classes defined yet. Please add classes in the Classes section above or assign teachers to create classes automatically.</div>
            <% } else { %>
                <div class="filter" style="margin-bottom: 16px;">
                    <label for="class-search">Search classes:</label>
                    <input type="text" id="class-search" placeholder="Search by class name..." oninput="filterClasses()" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;">
                </div>
                <div class="class-accordion-list" id="class-accordion-list">
                    <% teacherClasses.forEach(function(cls) { %>
                        <div class="class-accordion-card" data-class-name="<%= cls.toLowerCase() %>">
                            <div class="class-accordion-header" onclick="toggleClassDetails('<%= cls %>')">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span class="class-accordion-icon" id="icon-<%= cls %>">▼</span>
                                    <strong style="font-size: 16px;">Class <%= cls %></strong>
                                </div>
                                <span class="badge"><%= (classYearTeachers[cls] || []).length %> teacher(s)</span>
                            </div>
                            <div class="class-accordion-details" id="details-<%= cls %>" style="display: none;">
                            
                            <% 
                                const assignedTeacherIds = classYearTeachers[cls] || [];
                                const assignedTeachers = teachers.filter(t => assignedTeacherIds.includes(t.uid));
                            %>
                            
                            <!-- Classmaster Assignment -->
                            <% 
                                const classMasters = school.classMasters || {};
                                // Try both exact match and uppercase match for class name
                                const currentClassmasterId = classMasters[cls] || classMasters[cls.toUpperCase()] || classMasters[cls.toLowerCase()];
                                const currentClassmaster = currentClassmasterId ? teachers.find(t => t.uid === currentClassmasterId) : null;
                            %>
                            <div class="person" style="margin-bottom: 14px;">
                                <div>
                                    <strong style="font-size: 14px; display: block; margin-bottom: 8px;">Classmaster:</strong>
                                    <% if (currentClassmaster) { %>
                                        <div>
                                            <strong><%= currentClassmaster.name %></strong>
                                            <small><%= currentClassmaster.email %></small>
                                        </div>
                                    <% } else { %>
                                        <small class="helper">No classmaster assigned</small>
                                    <% } %>
                                </div>
                                <% if (currentClassmaster) { %>
                                    <form action="/admin/remove-classmaster" method="POST" style="margin: 0;">
                                        <input type="hidden" name="className" value="<%= cls %>">
                                        <button type="submit" class="btn-remove">Remove</button>
                                    </form>
                                <% } else { %>
                                    <form action="/admin/assign-classmaster" method="POST" style="display: flex; gap: 8px; align-items: center; margin: 0;">
                                        <input type="hidden" name="className" value="<%= cls %>">
                                        <select name="teacherId" required style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;">
                                            <option value="">Select Teacher</option>
                                            <% if (assignedTeachers.length > 0) { %>
                                                <% assignedTeachers.forEach(function(t) { %>
                                                    <option value="<%= t.uid %>"><%= t.name %></option>
                                                <% }); %>
                                            <% } else { %>
                                                <% teachers.forEach(function(t) { %>
                                                    <option value="<%= t.uid %>"><%= t.name %></option>
                                                <% }); %>
                                            <% } %>
                                        </select>
                                        <button type="submit" class="btn-primary">Assign</button>
                                    </form>
                                <% } %>
                            </div>

                            <% 
                                const availableTeachers = teachers.filter(t => !assignedTeacherIds.includes(t.uid));
                            %>

                        <% if (assignedTeachers.length > 0) { %>
                            <div class="people-list" style="margin-bottom: 14px;">
                                <% assignedTeachers.forEach(function(teacher) { %>
                                        <% 
                                            const teacherAllSubjects = teacher.subjects || (teacher.subject ? [teacher.subject] : []);
                                            const assignment = school.teacherAssignments && school.teacherAssignments[cls] && school.teacherAssignments[cls][teacher.uid];
                                            const assignedSubjects = assignment && assignment.subjects ? assignment.subjects : teacherAllSubjects;
                                        %>
                                    <div class="person">
                                        <div>
                                            <strong><%= teacher.name %></strong>
                                            <small>
                                                <% if (assignedSubjects.length > 0) { %>
                                                    Teaching: <%= assignedSubjects.join(', ') %>
                                                <% } else { %>
                                                    No subjects for this grade
                                                <% } %>
                                            </small>
                                        </div>
                                            <form action="/admin/remove-teacher-assignment" method="POST" style="margin: 0;">
                                                <input type="hidden" name="classYear" value="<%= cls %>">
                                                <input type="hidden" name="teacherId" value="<%= teacher.uid %>">
                                                <button type="submit" class="btn-remove">Remove</button>
                                            </form>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <p class="helper" style="margin-bottom: 14px;">No teachers assigned yet.</p>
                        <% } %> 

                            <% if (availableTeachers.length > 0) { %>
                                <div class="batch-assignment-container" id="batch-assignment-<%= cls %>">
                                    <div class="teacher-selection-list">
                                        <% availableTeachers.forEach(function(teacher) { %>
                                            <% 
                                                const teacherSubjects = teacher.subjects || (teacher.subject ? [teacher.subject] : []);
                                            %>
                                            <div class="teacher-assignment-card" data-teacher-id="<%= teacher.uid %>">
                                                <label class="teacher-card-header">
                                                    <input type="checkbox" 
                                                           class="teacher-select-checkbox" 
                                                           value="<%= teacher.uid %>"
                                                           data-year="<%= cls %>"
                                                           data-subjects='<%= JSON.stringify(teacherSubjects) %>'
                                                           onchange="toggleTeacherSubjects('<%= cls %>', '<%= teacher.uid %>')">
                                                <div class="teacher-info">
                                                    <strong><%= teacher.name %></strong>
                                                    <small><%= teacher.email %></small>
                                                    <% if (teacherSubjects.length > 0) { %>
                                                        <small style="color: var(--accent); margin-top: 2px;">
                                                            Knows: <%= teacherSubjects.join(', ') %>
                                                        </small>
                                                    <% } %>
                                                </div>
                                            </label>
                                            
                                                    <!-- Subject selection (shown when teacher checkbox is checked) -->
                                                    <div id="subjects-<%= cls %>-<%= teacher.uid %>" 
                                                         class="subject-selection-inline" 
                                                         style="display: none;">
                                                        <% if (teacherSubjects.length > 0) { %>
                                                            <div class="inline-subjects">
                                                                <% teacherSubjects.forEach(function(subject) { %>
                                                                    <label class="subject-pill">
                                                                        <input type="checkbox" 
                                                                               class="subject-checkbox"
                                                                               data-teacher-id="<%= teacher.uid %>"
                                                                               data-year="<%= cls %>"
                                                                               value="<%= subject %>" 
                                                                               checked>
                                                                        <span><%= subject %></span>
                                                                    </label>
                                                                <% }); %>
                                                            </div>
                                                        <% } else { %>
                                                            <small class="helper">No subjects assigned to this teacher</small>
                                                        <% } %>
                                                    </div>
                                                </div>
                                            <% }); %>
                                        </div>
                                        
                                        <button type="button" 
                                                class="btn-primary" 
                                                style="margin-top: 16px; width: 100%;"
                                                onclick="assignSelectedTeachers('<%= cls %>')"
                                                id="assign-btn-<%= cls %>"
                                                disabled>
                                            Assign Selected Teachers
                                        </button>
                                    </div>
                                <% } else { %>
                                    <p class="helper">All teachers have been assigned to this class.</p>
                                <% } %>

                            <!-- Show derived subjects -->
                            <% 
                                const derivedSubjects = [...new Set(assignedTeachers.flatMap(t => {
                                    const subjects = t.subjects || (t.subject ? [t.subject] : []);
                                    return subjects;
                                }))];
                            %>
                            <% if (derivedSubjects.length > 0) { %>
                                <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border);">
                                    <small class="helper" style="font-weight: 600;">Available subjects:</small>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
                                        <% derivedSubjects.forEach(function(subject) { %>
                                            <span class="badge"><%= subject %></span>
                                        <% }); %>   
                                    </div>
                                </div>
                            <% } %>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } %>
        </section>

        <!-- People Section -->
        <section id="people" class="section">
                    <h2>People</h2>
            <p class="helper" style="margin-bottom: 16px;">Filter and view your teachers and students.</p>

            <div class="grid-two">
                <!-- Teachers -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong style="font-size: 16px;">Teachers</strong>
                        <span class="badge" id="teacher-count"><%= teachers.length %></span>
                    </div>
                    <% if (teachers.length > 0) { %>
                        <div class="filter">
                            <label for="teacher-search">Search by name:</label>
                            <input type="text" id="teacher-search" placeholder="Search teachers..." oninput="filterTeachers()" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;">
                        </div>
                        <div class="filter">
                            <label for="subject-filter">Filter by subject:</label>
                            <select id="subject-filter" onchange="filterTeachers()">
                                <option value="all">All</option>
                                <% if (school.subjects && school.subjects.length > 0) { %>
                                    <% school.subjects.forEach(function(subject) { %>
                                        <option value="<%= subject %>"><%= subject %></option>
                                    <% }); %>
                                <% } %>
                                <option value="none">No subject</option>
                            </select>
                        </div>
                        <div class="people-list" id="teachers-grid">
                            <% teachers.forEach(function(t) { %>
                                <% 
                                    const teacherSubjects = t.subjects || (t.subject ? [t.subject] : []);
                                    const subjectStr = teacherSubjects.length > 0 ? teacherSubjects.join(',') : 'none';
                                %>
                                <div class="person teacher-item" data-subjects="<%= subjectStr %>" data-name="<%= t.name.toLowerCase() %>" data-email="<%= t.email.toLowerCase() %>">
                                    <div>
                                        <strong><%= t.name %></strong>
                                        <small><%= t.email %></small>
                                        <% if (teacherSubjects.length > 0) { %>
                                            <br><small><%= teacherSubjects.join(', ') %></small>
                                        <% } %>
                                    </div>
                                    <button type="button" class="btn-edit" 
                                            data-uid="<%= t.uid %>"
                                            data-role="teacher"
                                            data-name="<%= t.name %>"
                                            data-email="<%= t.email %>"
                                            data-classyear="<%= t.classYear || "" %>"
                                            data-subjects='<%= JSON.stringify(teacherSubjects) %>'
                                            data-parentemail="<%= t.parentEmail || "" %>"
                                            onclick="openEditModalFromButton(this)" 
                                            style="padding: 6px 12px; font-size: 13px;">Edit</button>
                                </div>
                            <% }); %>
                        </div>
                        <p id="no-teachers-filtered" class="helper" style="display: none; margin-top: 10px;">No teachers match this filter.</p>
                    <% } else { %>
                        <div class="muted-box">No teachers yet.</div>
                    <% } %>
                </div>

                <!-- Students -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong style="font-size: 16px;">Students</strong>
                        <span class="badge" id="student-count"><%= students.length %></span>
                    </div>
                    <% if (students.length > 0) { %>
                        <div class="filter">
                            <label for="student-search">Search by name:</label>
                            <input type="text" id="student-search" placeholder="Search students..." oninput="filterStudents()" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); font-size: 14px;">
                        </div>
                        <div class="filter">
                            <label for="class-filter">Filter by class:</label>
                            <select id="class-filter" onchange="filterStudents()">
                                <option value="all">All</option>
                                <% (typeof allClasses !== 'undefined' ? allClasses : (school.classes || [])).forEach(function(cls) { %>
                                    <option value="<%= cls %>"><%= cls %></option>
                                <% }); %>
                                <option value="none">No class</option>
                            </select>
                        </div>
                        <div class="people-list" id="students-grid">
                            <% students.forEach(function(s) { %>
                                <div class="person student-item" data-classyear="<%= s.classYear || 'none' %>" data-name="<%= s.name.toLowerCase() %>" data-email="<%= s.email.toLowerCase() %>">
                                    <div>
                                        <strong><%= s.name %></strong>
                                        <small><%= s.email %></small>
                                        <% if (s.classYear) { %><br><small>Grade <%= s.classYear %></small><% } %>
                                    </div>
                                    <button type="button" class="btn-edit" 
                                            data-uid="<%= s.uid %>"
                                            data-role="student"
                                            data-name="<%= s.name %>"
                                            data-email="<%= s.email %>"
                                            data-classyear="<%= s.classYear || "" %>"
                                            data-subjects=""
                                            data-parentemail="<%= s.parentEmail || "" %>"
                                            onclick="openEditModalFromButton(this)" 
                                            style="padding: 6px 12px; font-size: 13px;">Edit</button>
                                </div>
                            <% }); %>
                        </div>
                        <p id="no-students-filtered" class="helper" style="display: none; margin-top: 10px;">No students match this filter.</p>
                    <% } else { %>
                        <div class="muted-box">No students yet.</div>
                    <% } %>
                </div>
            </div>
        </section>

        <!-- Academic Year Management Section -->
        <section class="section" style="border: 2px solid var(--error); padding: 20px; border-radius: 8px; background: rgba(248, 113, 113, 0.05); margin-bottom: 40px;">
            <h2 style="color: var(--error);">⚠️ Academic Year Management</h2>
            <p class="helper" style="margin-bottom: 16px;">Advance all students to the next grade level and clear all academic records for the new year. This action is <strong>irreversible</strong>.</p>
            <button type="button" class="danger-btn" onclick="showAdvanceYearModal()" style="margin-top: 12px; padding: 12px 24px; font-size: 15px;">
                Advance Academic Year
            </button>
        </section>

        <!-- Footer -->
        <div class="dashboard-footer">
            <form action="/auth/logout" method="GET">
                <button type="submit" class="btn-primary">Logout</button>
            </form>
        </div>
    </div>

    <!-- Delete Subject Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Subject Deletion</h3>
            <p id="modal-message"></p>
            <div class="modal-actions">
                <button class="ghost-btn" type="button" onclick="closeModal()">Cancel</button>
                <button class="danger-btn" type="button" onclick="deleteSubject()">Delete Subject</button>
            </div>
        </div>
    </div>

    <!-- Advance Academic Year Modal -->
    <div id="advanceYearModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <h3 style="color: var(--error);">⚠️ Advance Academic Year</h3>
            <div style="background: rgba(248, 113, 113, 0.1); border-left: 4px solid var(--error); padding: 16px; margin: 16px 0; border-radius: 4px;">
                <p style="margin: 0 0 12px 0; font-weight: 600;">This action will:</p>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>Advance all students by one grade level (e.g., Grade 5 → Grade 6, 9A → 10A)</li>
                    <li><strong>Permanently delete ALL grades</strong> for all students</li>
                    <li><strong>Permanently delete ALL absences</strong> for all students</li>
                    <li>This action <strong>cannot be undone</strong></li>
                </ul>
            </div>
            <p style="margin: 16px 0;"><strong>Students affected: <%= students.length %></strong></p>
            <p style="margin-bottom: 20px; color: var(--text-dim);">To confirm, type <strong style="color: var(--error);">ADVANCE YEAR</strong> in the field below:</p>
            <form id="advanceYearForm" onsubmit="handleAdvanceYear(event)">
                <div class="field" style="margin-bottom: 20px;">
                    <label for="confirm-text">Confirmation</label>
                    <input type="text" id="confirm-text" name="confirmText" placeholder="Type: ADVANCE YEAR" required style="text-transform: uppercase;">
                </div>
                <div class="modal-actions">
                    <button class="ghost-btn" type="button" onclick="closeAdvanceYearModal()">Cancel</button>
                    <button class="danger-btn" type="submit">Advance Academic Year</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>Edit User</h3>
            <form id="editUserForm" onsubmit="handleEditUser(event)">
                <input type="hidden" id="edit-user-uid" name="uid">
                <input type="hidden" id="edit-user-role" name="role">
                
                <div class="field" style="margin-bottom: 16px;">
                    <label for="edit-user-name">Full Name</label>
                    <input type="text" id="edit-user-name" name="name" required>
                </div>
                
                <div class="field" style="margin-bottom: 16px;">
                    <label for="edit-user-email">Email</label>
                    <input type="email" id="edit-user-email" name="email" required>
                </div>
                
                <div class="field" id="edit-classYearGroup" style="margin-bottom: 16px; display: none;">
                    <label for="edit-user-classYear">Class</label>
                    <select id="edit-user-classYear" name="classYear">
                        <option value="">Select class</option>
                        <% (typeof allClasses !== 'undefined' ? allClasses : (school.classes || [])).forEach(function(cls) { %>
                            <option value="<%= cls %>"><%= cls %></option>
                        <% }); %>
                    </select>
                </div>
                
                <div class="field" id="edit-subjectGroup" style="margin-bottom: 16px; display: none;">
                    <label for="edit-user-subjects">Subjects</label>
                    <select id="edit-user-subjects" name="subjects" multiple style="min-height: 120px;">
                        <% if (school.subjects && school.subjects.length > 0) { %>
                            <% school.subjects.forEach(function(subject) { %>
                                <option value="<%= subject %>"><%= subject %></option>
                            <% }); %>
                        <% } %>
                    </select>
                    <small class="helper">Hold Ctrl/Cmd to select multiple subjects</small>
                </div>
                
                <div class="field" id="edit-parentEmailGroup" style="margin-bottom: 16px; display: none;">
                    <label for="edit-user-parentEmail">Parent Email (Optional)</label>
                    <input type="email" id="edit-user-parentEmail" name="parentEmail" placeholder="parent@example.com">
                    <small class="helper">Leave empty to keep current parent account</small>
                </div>
                
                <div class="modal-actions" style="margin-top: 20px;">
                    <button class="ghost-btn" type="button" onclick="closeEditModal()">Cancel</button>
                    <button class="btn-primary" type="submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="application/json" id="school-subjects-data">
        <%- JSON.stringify(school.subjects || []) %>
    </script>
    <script>
        let subjectToDelete = null;
        const schoolSubjects = JSON.parse(document.getElementById('school-subjects-data').textContent);

        // Generic AJAX form handler
        async function handleFormSubmit(event, form) {
            event.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Handle multiple values (like subjects checkboxes)
            const multiSelects = form.querySelectorAll('select[multiple]');
            multiSelects.forEach(select => {
                const selected = Array.from(select.selectedOptions).map(opt => opt.value);
                data[select.name] = selected;
            });

            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton?.textContent;
            const originalDisabled = submitButton?.disabled;
            
            if (submitButton) {
                submitButton.disabled = true;
            }

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Reload page after a short delay to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    // Show error message to admin
                    alert(`❌ Error: ${result.error || 'Operation failed'}`);
                    if (submitButton) {
                        submitButton.disabled = originalDisabled;
                        if (originalText) submitButton.textContent = originalText;
                    }
                }
            } catch (error) {
                console.error('Form submission error:', error);
                alert('❌ An error occurred. Please try again.');
                if (submitButton) {
                    submitButton.disabled = originalDisabled;
                    if (originalText) submitButton.textContent = originalText;
                }
            }
        }

        function validateSubjectForm() {
            const subjectName = document.getElementById('subjectName').value.trim();
            if (!subjectName) {
                alert('⚠️ Please enter a subject name');
                return false;
            }
            if (schoolSubjects.some(s => s.toLowerCase() === subjectName.toLowerCase())) {
                alert('⚠️ This subject already exists');
                return false;
            }
            return true;
        }

        async function confirmRemoveSubject(subjectName) {
            subjectToDelete = subjectName;
            try {
                const response = await fetch('/admin/check-subject-usage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subjectName })
                });
                const data = await response.json();
                const message = document.getElementById('modal-message');
                if (data.inUse && data.count > 0) {
                    message.innerHTML = `Warning: This subject is currently assigned to <strong>${data.count} teacher(s)</strong>. Deleting it will not affect existing teacher assignments, but the subject will no longer be available for new assignments.<br><br>Are you sure you want to delete "<strong>${subjectName}</strong>"?`;
                } else {
                    message.innerHTML = `Are you sure you want to delete "<strong>${subjectName}</strong>"?`;
                }
                document.getElementById('deleteModal').classList.add('active');
            } catch (err) {
                console.error('Error checking subject usage:', err);
            }
        }

        function closeModal() {
            document.getElementById('deleteModal').classList.remove('active');
            subjectToDelete = null;
        }

        async function deleteSubject() {
            if (!subjectToDelete) return;
            
            const deleteBtn = document.querySelector('#deleteModal .danger-btn');
            const originalText = deleteBtn.textContent;
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';

            try {
                const response = await fetch('/admin/remove-subject', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ subjectName: subjectToDelete })
                });

                const result = await response.json();

                if (result.success) {
                    closeModal();
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    console.error('Delete subject error:', result.error || 'Failed to delete subject');
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = originalText;
                }
            } catch (error) {
                console.error('Delete subject error:', error);
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        }

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('deleteModal');
            if (e.target === modal) closeModal();
        });

        function toggleRoleFields() {
            const role = document.getElementById('role').value;
            const classYearGroup = document.getElementById('classYearGroup');
            const classYearSelect = document.getElementById('classYear');
            const subjectGroup = document.getElementById('subjectGroup');
            const subjectSelect = document.getElementById('subject');
            const parentEmailGroup = document.getElementById('parentEmailGroup');
            const parentPasswordGroup = document.getElementById('parentPasswordGroup');

            if (role === 'student') {
                classYearGroup.style.display = 'block';
                classYearSelect.required = true;
                subjectGroup.style.display = 'none';
                subjectSelect.required = false;
                subjectSelect.value = '';
                parentEmailGroup.style.display = 'block';
                parentPasswordGroup.style.display = 'block';
            } else if (role === 'teacher') {
                classYearGroup.style.display = 'none';
                classYearSelect.required = false;
                classYearSelect.value = '';
                subjectGroup.style.display = 'block';
                subjectSelect.required = false;
                parentEmailGroup.style.display = 'none';
                parentPasswordGroup.style.display = 'none';
                document.getElementById('parentEmail').value = '';
                document.getElementById('parentPassword').value = '';
            } else {
                classYearGroup.style.display = 'none';
                classYearSelect.required = false;
                classYearSelect.value = '';
                subjectGroup.style.display = 'none';
                subjectSelect.required = false;
                subjectSelect.value = '';
                parentEmailGroup.style.display = 'none';
                parentPasswordGroup.style.display = 'none';
                document.getElementById('parentEmail').value = '';
                document.getElementById('parentPassword').value = '';
            }
        }

        function filterTeachers() {
            const selected = document.getElementById('subject-filter').value;
            const searchTerm = (document.getElementById('teacher-search').value || '').toLowerCase().trim();
            const items = document.querySelectorAll('.teacher-item');
            const msg = document.getElementById('no-teachers-filtered');
            const count = document.getElementById('teacher-count');
            let visible = 0;
            items.forEach(item => {
                const subjects = item.getAttribute('data-subjects');
                const subjectArray = subjects.split(',');
                const name = item.getAttribute('data-name') || '';
                const email = item.getAttribute('data-email') || '';
                
                // Check subject filter
                const subjectMatch = selected === 'all' || subjectArray.includes(selected);
                
                // Check name/email search
                const searchMatch = searchTerm === '' || name.includes(searchTerm) || email.includes(searchTerm);
                
                if (subjectMatch && searchMatch) {
                    item.style.display = 'flex';
                    visible++;
                } else {
                    item.style.display = 'none';
                }
            });
            count.textContent = visible;
            msg.style.display = visible === 0 ? 'block' : 'none';
        }

        function filterStudents() {
            const selected = document.getElementById('class-filter').value;
            const searchTerm = (document.getElementById('student-search').value || '').toLowerCase().trim();
            const items = document.querySelectorAll('.student-item');
            const msg = document.getElementById('no-students-filtered');
            const count = document.getElementById('student-count');
            let visible = 0;
            items.forEach(item => {
                const year = item.getAttribute('data-classyear');
                const name = item.getAttribute('data-name') || '';
                const email = item.getAttribute('data-email') || '';
                
                // Check class filter
                const classMatch = selected === 'all' || year === selected;
                
                // Check name/email search
                const searchMatch = searchTerm === '' || name.includes(searchTerm) || email.includes(searchTerm);
                
                if (classMatch && searchMatch) {
                    item.style.display = 'flex';
                    visible++;
                } else {
                    item.style.display = 'none';
                }
            });
            count.textContent = visible;
            msg.style.display = visible === 0 ? 'block' : 'none';
        }

        function toggleClassDetails(className) {
            const details = document.getElementById(`details-${className}`);
            const icon = document.getElementById(`icon-${className}`);
            const card = icon.closest('.class-accordion-card');
            
            if (!details || !icon || !card) return;
            
            const isExpanded = details.style.display !== 'none';
            
            if (isExpanded) {
                details.style.display = 'none';
                icon.textContent = '▼';
                card.classList.remove('expanded');
            } else {
                details.style.display = 'block';
                icon.textContent = '▲';
                card.classList.add('expanded');
            }
        }

        function filterClasses() {
            const searchTerm = (document.getElementById('class-search').value || '').toLowerCase().trim();
            const classCards = document.querySelectorAll('.class-accordion-card');
            let visibleCount = 0;
            
            classCards.forEach(card => {
                const className = card.getAttribute('data-class-name') || '';
                
                if (searchTerm === '' || className.includes(searchTerm)) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Show message if no classes match
            const accordionList = document.getElementById('class-accordion-list');
            let noResultsMsg = document.getElementById('no-classes-filtered');
            
            if (visibleCount === 0 && searchTerm !== '') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('p');
                    noResultsMsg.id = 'no-classes-filtered';
                    noResultsMsg.className = 'helper';
                    noResultsMsg.style.marginTop = '16px';
                    noResultsMsg.textContent = 'No classes match your search.';
                    accordionList.parentNode.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        // Batch Assignment Functions
        function toggleTeacherSubjects(year, teacherId) {
            const checkbox = document.querySelector(
                `input.teacher-select-checkbox[value="${teacherId}"][data-year="${year}"]`
            );
            const subjectsDiv = document.getElementById(`subjects-${year}-${teacherId}`);
            
            if (checkbox && checkbox.checked) {
                subjectsDiv.style.display = 'block';
                // Check all subject checkboxes by default
                subjectsDiv.querySelectorAll('input.subject-checkbox').forEach(cb => {
                    cb.checked = true;
                });
            } else if (subjectsDiv) {
                subjectsDiv.style.display = 'none';
            }
            
            updateAssignButton(year);
        }


        async function assignSelectedTeachers(year) {
            const checkboxes = document.querySelectorAll(
                `input.teacher-select-checkbox[data-year="${year}"]:checked`
            );
            
            if (checkboxes.length === 0) {
                return;
            }
            
            const assignBtn = document.getElementById(`assign-btn-${year}`);
            const originalText = assignBtn.textContent;
            assignBtn.disabled = true;
            assignBtn.textContent = 'Assigning...';
            let successCount = 0;
            let errorCount = 0;
            
            for (const checkbox of checkboxes) {
                const teacherId = checkbox.value;
                const selectedSubjects = Array.from(
                    document.querySelectorAll(
                        `#subjects-${year}-${teacherId} input.subject-checkbox:checked`
                    )
                ).map(cb => cb.value);
                
                if (selectedSubjects.length === 0) {
                    errorCount++;
                    continue;
                }
                
                try {
                    const response = await fetch('/admin/assign-teacher-ajax', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            classYear: year, 
                            teacherId: teacherId, 
                            subjects: selectedSubjects 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Error assigning teacher:', error);
                    errorCount++;
                }
            }
            
            assignBtn.disabled = false;
            assignBtn.textContent = originalText;
            
            if (successCount > 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 800);
            } else if (errorCount > 0) {
                console.error(`Failed to assign ${errorCount} teacher(s)`);
            }
        }

        function updateAssignButton(year) {
            const checkboxes = document.querySelectorAll(
                `input.teacher-select-checkbox[data-year="${year}"]:checked`
            );
            const assignBtn = document.getElementById(`assign-btn-${year}`);
            
            if (assignBtn) {
                if (checkboxes.length > 0) {
                    assignBtn.disabled = false;
                    assignBtn.textContent = `Assign ${checkboxes.length} Selected Teacher(s)`;
                } else {
                    assignBtn.disabled = true;
                    assignBtn.textContent = 'Assign Selected Teachers';
                }
            }
        }

        // Edit User Modal Functions
        function openEditModalFromButton(button) {
            const uid = button.getAttribute('data-uid');
            const role = button.getAttribute('data-role');
            const name = button.getAttribute('data-name');
            const email = button.getAttribute('data-email');
            const classYear = button.getAttribute('data-classyear') || '';
            const subjectsJson = button.getAttribute('data-subjects') || '[]';
            const parentEmail = button.getAttribute('data-parentemail') || '';
            
            openEditModal(uid, role, name, email, classYear, subjectsJson, parentEmail);
        }

        function openEditModal(uid, role, name, email, classYear, subjectsJson, parentEmail) {
            const modal = document.getElementById('editUserModal');
            const form = document.getElementById('editUserForm');
            
            document.getElementById('edit-user-uid').value = uid;
            document.getElementById('edit-user-role').value = role;
            document.getElementById('edit-user-name').value = name;
            document.getElementById('edit-user-email').value = email;
            
            const classYearGroup = document.getElementById('edit-classYearGroup');
            const subjectGroup = document.getElementById('edit-subjectGroup');
            const parentEmailGroup = document.getElementById('edit-parentEmailGroup');
            const classYearSelect = document.getElementById('edit-user-classYear');
            const subjectSelect = document.getElementById('edit-user-subjects');
            const parentEmailInput = document.getElementById('edit-user-parentEmail');
            
            if (role === 'student') {
                classYearGroup.style.display = 'block';
                classYearSelect.value = classYear || '';
                subjectGroup.style.display = 'none';
                parentEmailGroup.style.display = 'block';
                parentEmailInput.value = parentEmail || '';
            } else if (role === 'teacher') {
                classYearGroup.style.display = 'none';
                subjectGroup.style.display = 'block';
                parentEmailGroup.style.display = 'none';
                
                // Parse and set subjects
                let subjects = [];
                try {
                    subjects = JSON.parse(subjectsJson.replace(/&apos;/g, "'"));
                } catch (e) {
                    subjects = [];
                }
                
                // Select subjects in the multi-select
                Array.from(subjectSelect.options).forEach(option => {
                    option.selected = subjects.includes(option.value);
                });
            }
            
            modal.classList.add('active');
        }

        function closeEditModal() {
            const modal = document.getElementById('editUserModal');
            const form = document.getElementById('editUserForm');
            modal.classList.remove('active');
            form.reset();
        }

        async function handleEditUser(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Handle multiple subjects for teachers
            if (data.role === 'teacher') {
                const subjectSelect = document.getElementById('edit-user-subjects');
                const selected = Array.from(subjectSelect.selectedOptions).map(opt => opt.value);
                data.subjects = selected;
            }
            
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            
            try {
                const response = await fetch('/admin/update-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeEditModal();
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    console.error('Update user error:', result.error || 'Operation failed');
                    alert(result.error || 'Failed to update user. Please try again.');
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            } catch (error) {
                console.error('Update user error:', error);
                alert('An error occurred. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        }

        // Close edit modal when clicking outside
        window.addEventListener('click', (e) => {
            const editModal = document.getElementById('editUserModal');
            if (e.target === editModal) closeEditModal();
            
            const advanceModal = document.getElementById('advanceYearModal');
            if (e.target === advanceModal) closeAdvanceYearModal();
        });

        // Advance Academic Year Functions
        function showAdvanceYearModal() {
            const modal = document.getElementById('advanceYearModal');
            modal.classList.add('active');
            document.getElementById('confirm-text').focus();
        }

        function closeAdvanceYearModal() {
            const modal = document.getElementById('advanceYearModal');
            const form = document.getElementById('advanceYearForm');
            modal.classList.remove('active');
            form.reset();
        }

        async function handleAdvanceYear(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Convert to uppercase for comparison
            data.confirmText = data.confirmText.toUpperCase().trim();
            
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
            
            try {
                const response = await fetch('/admin/advance-academic-year', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeAdvanceYearModal();
                    alert(`✅ ${result.message}\n\n- ${result.studentsUpdated} students advanced\n- ${result.gradesDeleted} grades deleted\n- ${result.absencesDeleted || 0} absences deleted`);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    alert(`❌ ${result.error || 'Failed to advance academic year'}`);
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            } catch (error) {
                console.error('Advance year error:', error);
                alert('❌ An error occurred. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide and remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Attach AJAX handlers to all forms
            const addSubjectForm = document.querySelector('form[action="/admin/add-subject"]');
            if (addSubjectForm) {
                addSubjectForm.addEventListener('submit', (e) => {
                    if (!validateSubjectForm()) {
                        e.preventDefault();
                        return false;
                    }
                    handleFormSubmit(e, addSubjectForm);
                });
            }

            // Add class form
            const addClassForm = document.querySelector('form[action="/admin/add-class"]');
            if (addClassForm) {
                addClassForm.addEventListener('submit', (e) => handleFormSubmit(e, addClassForm));
            }

            // Remove class forms (multiple)
            document.querySelectorAll('form[action="/admin/remove-class"]').forEach(form => {
                form.addEventListener('submit', (e) => handleFormSubmit(e, form));
            });

            // Assign classmaster forms
            document.querySelectorAll('form[action="/admin/assign-classmaster"]').forEach(form => {
                form.addEventListener('submit', (e) => handleFormSubmit(e, form));
            });

            // Remove classmaster forms
            document.querySelectorAll('form[action="/admin/remove-classmaster"]').forEach(form => {
                form.addEventListener('submit', (e) => handleFormSubmit(e, form));
            });

            // Remove teacher assignment forms
            document.querySelectorAll('form[action="/admin/remove-teacher-assignment"]').forEach(form => {
                form.addEventListener('submit', (e) => handleFormSubmit(e, form));
            });

            // Create user form
            const createUserForm = document.querySelector('form[action="/admin/create-user"]');
            if (createUserForm) {
                createUserForm.addEventListener('submit', (e) => {
                    handleFormSubmit(e, createUserForm).then(() => {
                        // Reset form on success
                        if (createUserForm) {
                            createUserForm.reset();
                            toggleRoleFields();
                        }
                    });
                });
            }

            const roleSelect = document.getElementById('role');
            if (roleSelect) {
                roleSelect.addEventListener('change', toggleRoleFields);
                toggleRoleFields();
            }
            
            // Initialize assign buttons state for all grades
            ['9', '10', '11', '12'].forEach(year => {
                updateAssignButton(year);
            });
        });
    </script>
</body>
</html>
