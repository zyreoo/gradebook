<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - <%= school.name %></title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
                    <h1><%= school.name %></h1>
            <div class="user-info">
                <p><strong>Name:</strong> <%= user.name %></p>
                <p><strong>Email:</strong> <%= user.email %></p>
                <p><strong>Role:</strong> School Administrator</p>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="section">
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-value"><%= teachers.length %></div>
                    <div class="stat-label">Teachers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><%= students.length %></div>
                    <div class="stat-label">Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><%= (school.subjects || []).length %></div>
                    <div class="stat-label">Subjects</div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message"><%= error %></div>
        <% } %>
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="success-message"><%= success %></div>
        <% } %>

        <!-- Navigation -->
        <div class="section-nav-admin">
            <a href="#subjects">Subjects</a>
            <a href="#teacher-assignments">Teacher Assignments</a>
            <a href="#add-user">Add User</a>
            <a href="#people">People</a>
        </div>

        <!-- Subject Library Section -->
        <section id="subjects" class="section">
            <h2>Subject Library</h2>
            <p class="helper" style="margin-bottom: 16px;">Keep your catalog tidy. Remove unused subjects or add new ones.</p>

            <% if (school.subjects && school.subjects.length > 0) { %>
                <div class="pill-rail">
                    <% school.subjects.forEach(function(subject) { %>
                        <div class="pill"> 
                            <span><%= subject %></span>
                            <button type="button" onclick="confirmRemoveSubject('<%= subject %>')" aria-label="Remove <%= subject %>">×</button>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="muted-box">No subjects yet. Add your first one below.</div>
            <% } %>

            <form action="/admin/add-subject" method="POST" onsubmit="return validateSubjectForm()" style="margin-top: 18px;">
                <div class="form-grid">
                    <div class="field">
                        <label for="subjectName">Add a subject</label>
                        <input id="subjectName" name="subjectName" type="text" placeholder="e.g., Mathematics, Chemistry" maxlength="50" required>
                    </div>
                    <div class="field" style="align-self: flex-end;">
                        <button class="btn-primary" type="submit">Add Subject</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Teacher Assignments Section -->
        <section id="teacher-assignments" class="section">
                    <h2>Teacher Assignments</h2>
            <p class="helper" style="margin-bottom: 16px;">Assign teachers to grade levels. Each grade's available subjects come from its assigned teachers.</p>

            <% const classYears = ['9', '10', '11', '12']; %>
            <% const classYearTeachers = school.classYearTeachers || {}; %>
            
            <div class="grid-two">
                <% classYears.forEach(function(year) { %>
                    <div class="section-subsection">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                            <strong style="font-size: 16px;">Grade <%= year %></strong>
                            <span class="badge"><%= (classYearTeachers[year] || []).length %> teacher(s)</span>
                        </div>

                        <% 
                            const assignedTeacherIds = classYearTeachers[year] || [];
                            const assignedTeachers = teachers.filter(t => assignedTeacherIds.includes(t.uid));
                            const availableTeachers = teachers.filter(t => !assignedTeacherIds.includes(t.uid));
                        %>

                        <% if (assignedTeachers.length > 0) { %>
                            <div class="people-list" style="margin-bottom: 14px;">
                                <% assignedTeachers.forEach(function(teacher) { %>
                                    <% 
                                        const teacherAllSubjects = teacher.subjects || (teacher.subject ? [teacher.subject] : []);
                                        const assignment = school.teacherAssignments && school.teacherAssignments[year] && school.teacherAssignments[year][teacher.uid];
                                        const assignedSubjects = assignment && assignment.subjects ? assignment.subjects : teacherAllSubjects;
                                    %>
                                    <div class="person">
                                        <div>
                                            <strong><%= teacher.name %></strong>
                                            <small>
                                                <% if (assignedSubjects.length > 0) { %>
                                                    Teaching: <%= assignedSubjects.join(', ') %>
                                                <% } else { %>
                                                    No subjects for this grade
                                                <% } %>
                                            </small>
                                        </div>
                                        <form action="/admin/remove-teacher-assignment" method="POST" style="margin: 0;">
                                            <input type="hidden" name="classYear" value="<%= year %>">
                                            <input type="hidden" name="teacherId" value="<%= teacher.uid %>">
                                            <button type="submit" class="btn-remove">Remove</button>
                                        </form>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <p class="helper" style="margin-bottom: 14px;">No teachers assigned yet.</p>
                        <% } %>

                        <% if (availableTeachers.length > 0) { %>
                            <div class="batch-assignment-container" id="batch-assignment-<%= year %>">
                                <div class="teacher-selection-list">
                                    <% availableTeachers.forEach(function(teacher) { %>
                                        <% 
                                            const teacherSubjects = teacher.subjects || (teacher.subject ? [teacher.subject] : []);
                                        %>
                                        <div class="teacher-assignment-card" data-teacher-id="<%= teacher.uid %>">
                                            <label class="teacher-card-header">
                                                <input type="checkbox" 
                                                       class="teacher-select-checkbox" 
                                                       value="<%= teacher.uid %>"
                                                       data-year="<%= year %>"
                                                       data-subjects='<%= JSON.stringify(teacherSubjects) %>'
                                                       onchange="toggleTeacherSubjects('<%= year %>', '<%= teacher.uid %>')">
                                                <div class="teacher-info">
                                                    <strong><%= teacher.name %></strong>
                                                    <small><%= teacher.email %></small>
                                                    <% if (teacherSubjects.length > 0) { %>
                                                        <small style="color: var(--accent); margin-top: 2px;">
                                                            Knows: <%= teacherSubjects.join(', ') %>
                                                        </small>
                                                    <% } %>
                                                </div>
                                            </label>
                                            
                                            <!-- Subject selection (shown when teacher checkbox is checked) -->
                                            <div id="subjects-<%= year %>-<%= teacher.uid %>" 
                                                 class="subject-selection-inline" 
                                                 style="display: none;">
                                                <% if (teacherSubjects.length > 0) { %>
                                                    <div class="inline-subjects">
                                                        <% teacherSubjects.forEach(function(subject) { %>
                                                            <label class="subject-pill">
                                                                <input type="checkbox" 
                                                                       class="subject-checkbox"
                                                                       data-teacher-id="<%= teacher.uid %>"
                                                                       data-year="<%= year %>"
                                                                       value="<%= subject %>" 
                                                                       checked>
                                                                <span><%= subject %></span>
                                                            </label>
                                                        <% }); %>
                                                    </div>
                                                <% } else { %>
                                                    <small class="helper">No subjects assigned to this teacher</small>
                                                <% } %>
                                            </div>
                                        </div>
                                    <% }); %>
                                </div>
                                
                                <button type="button" 
                                        class="btn-primary" 
                                        style="margin-top: 16px; width: 100%;"
                                        onclick="assignSelectedTeachers('<%= year %>')"
                                        id="assign-btn-<%= year %>"
                                        disabled>
                                    Assign Selected Teachers
                                </button>
                            </div>
                        <% } else { %>
                            <p class="helper">All teachers have been assigned to this grade.</p>
                        <% } %>

                        <!-- Show derived subjects -->
                        <% 
                            const derivedSubjects = [...new Set(assignedTeachers.filter(t => t.subject).map(t => t.subject))];
                        %>
                        <% if (derivedSubjects.length > 0) { %>
                            <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border);">
                                <small class="helper" style="font-weight: 600;">Available subjects:</small>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
                                    <% derivedSubjects.forEach(function(subject) { %>
                                        <span class="badge"><%= subject %></span>
                                    <% }); %>   
                                </div>
                            </div>
                        <% } %>
                    </div>
                <% }); %>
            </div>
        </section>

        <!-- Create User Section -->
        <section id="add-user" class="section">
            <h2>Create a User</h2>
            <p class="helper" style="margin-bottom: 16px;">Add teachers or students and set the right fields in one pass.</p>
            
            <form action="/admin/create-user" method="POST">
                <div class="form-grid">
                    <div class="field">
                        <label for="name">Full name</label>
                        <input id="name" name="name" type="text" placeholder="Jane Smith" autocomplete="name" required>
                    </div>
                    <div class="field">
                        <label for="email">Email</label>
                        <input id="email" name="email" type="email" placeholder="jane.smith@school.edu" autocomplete="email" required>
                    </div>
                    <div class="field">
                        <label for="password">Password</label>
                        <input id="password" name="password" type="password" minlength="6" placeholder="Minimum 6 characters" autocomplete="new-password" required>
                    </div>
                    <div class="field">
                        <label for="confirmPassword">Confirm password</label>
                        <input id="confirmPassword" name="confirmPassword" type="password" minlength="6" placeholder="Re-enter password" autocomplete="new-password" required>
                    </div>
                    <div class="field">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="">Select role</option>
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                        </select>
                    </div>
                    <div class="field" id="classYearGroup" style="display: none;">
                        <label for="classYear">Grade level</label>
                        <select id="classYear" name="classYear">
                            <option value="">Select grade</option>
                            <option value="9">9th Grade</option>
                            <option value="10">10th Grade</option>
                            <option value="11">11th Grade</option>
                            <option value="12">12th Grade</option>
                        </select>
                    </div>
                    <div class="field" id="subjectGroup" style="display: none;">
                        <label for="subject">Subjects</label>
                        <select id="subject" name="subjects" multiple style="min-height: 120px;">
                            <% if (school.subjects && school.subjects.length > 0) { %>
                                <% school.subjects.forEach(function(subject) { %>
                                    <option value="<%= subject %>"><%= subject %></option>
                                <% }); %>
                            <% } %>
                        </select>
                        <small class="helper">Hold Ctrl/Cmd to select multiple subjects</small>
                    </div>
                </div>
                <div style="margin-top: 14px;">
                    <button class="btn-primary" type="submit">Create User</button>
                </div>
            </form>
        </section>

        <!-- People Section -->
        <section id="people" class="section">
                    <h2>People</h2>
            <p class="helper" style="margin-bottom: 16px;">Filter and view your teachers and students.</p>

            <div class="grid-two">
                <!-- Teachers -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong style="font-size: 16px;">Teachers</strong>
                        <span class="badge" id="teacher-count"><%= teachers.length %></span>
                    </div>
                    <% if (teachers.length > 0) { %>
                        <div class="filter">
                            <label for="subject-filter">Filter by subject:</label>
                            <select id="subject-filter" onchange="filterTeachers()">
                                <option value="all">All</option>
                                <% if (school.subjects && school.subjects.length > 0) { %>
                                    <% school.subjects.forEach(function(subject) { %>
                                        <option value="<%= subject %>"><%= subject %></option>
                                    <% }); %>
                                <% } %>
                                <option value="none">No subject</option>
                            </select>
                        </div>
                        <div class="people-list" id="teachers-grid">
                            <% teachers.forEach(function(t) { %>
                                <% 
                                    const teacherSubjects = t.subjects || (t.subject ? [t.subject] : []);
                                    const subjectStr = teacherSubjects.length > 0 ? teacherSubjects.join(',') : 'none';
                                %>
                                <div class="person teacher-item" data-subjects="<%= subjectStr %>">
                                    <div>
                                        <strong><%= t.name %></strong>
                                        <small><%= t.email %></small>
                                        <% if (teacherSubjects.length > 0) { %>
                                            <br><small><%= teacherSubjects.join(', ') %></small>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                        <p id="no-teachers-filtered" class="helper" style="display: none; margin-top: 10px;">No teachers match this filter.</p>
                    <% } else { %>
                        <div class="muted-box">No teachers yet.</div>
                    <% } %>
                </div>

                <!-- Students -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong style="font-size: 16px;">Students</strong>
                        <span class="badge" id="student-count"><%= students.length %></span>
                    </div>
                    <% if (students.length > 0) { %>
                        <div class="filter">
                            <label for="class-filter">Filter by grade:</label>
                            <select id="class-filter" onchange="filterStudents()">
                                <option value="all">All</option>
                                <option value="9">9th Grade</option>
                                <option value="10">10th Grade</option>
                                <option value="11">11th Grade</option>
                                <option value="12">12th Grade</option>
                                <option value="none">No grade</option>
                            </select>
                        </div>
                        <div class="people-list" id="students-grid">
                            <% students.forEach(function(s) { %>
                                <div class="person student-item" data-classyear="<%= s.classYear || 'none' %>">
                                    <div>
                                        <strong><%= s.name %></strong>
                                        <small><%= s.email %></small>
                                        <% if (s.classYear) { %><br><small>Grade <%= s.classYear %></small><% } %>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                        <p id="no-students-filtered" class="helper" style="display: none; margin-top: 10px;">No students match this filter.</p>
                    <% } else { %>
                        <div class="muted-box">No students yet.</div>
                    <% } %>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <div class="dashboard-footer">
            <form action="/auth/logout" method="GET">
                <button type="submit" class="btn-primary">Logout</button>
            </form>
        </div>
    </div>

    <!-- Delete Subject Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Subject Deletion</h3>
            <p id="modal-message"></p>
            <div class="modal-actions">
                <button class="ghost-btn" type="button" onclick="closeModal()">Cancel</button>
                <button class="danger-btn" type="button" onclick="deleteSubject()">Delete Subject</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="application/json" id="school-subjects-data">
        <%- JSON.stringify(school.subjects || []) %>
    </script>
    <script>
        let subjectToDelete = null;
        const schoolSubjects = JSON.parse(document.getElementById('school-subjects-data').textContent);

        function validateSubjectForm() {
            const subjectName = document.getElementById('subjectName').value.trim();
            if (!subjectName) {
                alert('Please enter a subject name');
                return false;
            }
            if (schoolSubjects.some(s => s.toLowerCase() === subjectName.toLowerCase())) {
                alert('This subject already exists');
                return false;
            }
            return true;
        }

        async function confirmRemoveSubject(subjectName) {
            subjectToDelete = subjectName;
            try {
                const response = await fetch('/admin/check-subject-usage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subjectName })
                });
                const data = await response.json();
                const message = document.getElementById('modal-message');
                if (data.inUse && data.count > 0) {
                    message.innerHTML = `Warning: This subject is currently assigned to <strong>${data.count} teacher(s)</strong>. Deleting it will not affect existing teacher assignments, but the subject will no longer be available for new assignments.<br><br>Are you sure you want to delete "<strong>${subjectName}</strong>"?`;
                } else {
                    message.innerHTML = `Are you sure you want to delete "<strong>${subjectName}</strong>"?`;
                }
                document.getElementById('deleteModal').classList.add('active');
            } catch (err) {
                console.error('Error checking subject usage:', err);
                alert('Error checking subject usage. Please try again.');
            }
        }

        function closeModal() {
            document.getElementById('deleteModal').classList.remove('active');
            subjectToDelete = null;
        }

        function deleteSubject() {
            if (!subjectToDelete) return;
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/remove-subject';
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'subjectName';
            input.value = subjectToDelete;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('deleteModal');
            if (e.target === modal) closeModal();
        });

        function toggleRoleFields() {
            const role = document.getElementById('role').value;
            const classYearGroup = document.getElementById('classYearGroup');
            const classYearSelect = document.getElementById('classYear');
            const subjectGroup = document.getElementById('subjectGroup');
            const subjectSelect = document.getElementById('subject');

            if (role === 'student') {
                classYearGroup.style.display = 'block';
                classYearSelect.required = true;
                subjectGroup.style.display = 'none';
                subjectSelect.required = false;
                subjectSelect.value = '';
            } else if (role === 'teacher') {
                classYearGroup.style.display = 'none';
                classYearSelect.required = false;
                classYearSelect.value = '';
                subjectGroup.style.display = 'block';
                subjectSelect.required = false;
            } else {
                classYearGroup.style.display = 'none';
                classYearSelect.required = false;
                classYearSelect.value = '';
                subjectGroup.style.display = 'none';
                subjectSelect.required = false;
                subjectSelect.value = '';
            }
        }

        function filterTeachers() {
            const selected = document.getElementById('subject-filter').value;
            const items = document.querySelectorAll('.teacher-item');
            const msg = document.getElementById('no-teachers-filtered');
            const count = document.getElementById('teacher-count');
            let visible = 0;
            items.forEach(item => {
                const subjects = item.getAttribute('data-subjects');
                const subjectArray = subjects.split(',');
                if (selected === 'all' || subjectArray.includes(selected)) {
                    item.style.display = 'flex';
                    visible++;
                } else {
                    item.style.display = 'none';
                }
            });
            count.textContent = visible;
            msg.style.display = visible === 0 ? 'block' : 'none';
        }

        function filterStudents() {
            const selected = document.getElementById('class-filter').value;
            const items = document.querySelectorAll('.student-item');
            const msg = document.getElementById('no-students-filtered');
            const count = document.getElementById('student-count');
            let visible = 0;
            items.forEach(item => {
                const year = item.getAttribute('data-classyear');
                if (selected === 'all' || year === selected) {
                    item.style.display = 'flex';
                    visible++;
                } else {
                    item.style.display = 'none';
                }
            });
            count.textContent = visible;
            msg.style.display = visible === 0 ? 'block' : 'none';
        }

        // Batch Assignment Functions
        function toggleTeacherSubjects(year, teacherId) {
            const checkbox = document.querySelector(
                `input.teacher-select-checkbox[value="${teacherId}"][data-year="${year}"]`
            );
            const subjectsDiv = document.getElementById(`subjects-${year}-${teacherId}`);
            
            if (checkbox && checkbox.checked) {
                subjectsDiv.style.display = 'block';
                // Check all subject checkboxes by default
                subjectsDiv.querySelectorAll('input.subject-checkbox').forEach(cb => {
                    cb.checked = true;
                });
            } else if (subjectsDiv) {
                subjectsDiv.style.display = 'none';
            }
            
            updateAssignButton(year);
        }


        async function assignSelectedTeachers(year) {
            const checkboxes = document.querySelectorAll(
                `input.teacher-select-checkbox[data-year="${year}"]:checked`
            );
            
            if (checkboxes.length === 0) {
                showToast('⚠️ Please select at least one teacher', 'warning');
                return;
            }
            
            const assignBtn = document.getElementById(`assign-btn-${year}`);
            const originalText = assignBtn.textContent;
            assignBtn.disabled = true;
            assignBtn.textContent = 'Assigning...';
            let successCount = 0;
            let errorCount = 0;
            
            for (const checkbox of checkboxes) {
                const teacherId = checkbox.value;
                const selectedSubjects = Array.from(
                    document.querySelectorAll(
                        `#subjects-${year}-${teacherId} input.subject-checkbox:checked`
                    )
                ).map(cb => cb.value);
                
                if (selectedSubjects.length === 0) {
                    errorCount++;
                    continue;
                }
                
                try {
                    const response = await fetch('/admin/assign-teacher-ajax', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            classYear: year, 
                            teacherId: teacherId, 
                            subjects: selectedSubjects 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Error assigning teacher:', error);
                    errorCount++;
                }
            }
            
            assignBtn.disabled = false;
            assignBtn.textContent = originalText;
            
            if (successCount > 0) {
                showToast(`✅ ${successCount} teacher(s) assigned successfully!`, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 800);
            } else if (errorCount > 0) {
                showToast(`❌ Failed to assign ${errorCount} teacher(s)`, 'error');
            }
        }

        function updateAssignButton(year) {
            const checkboxes = document.querySelectorAll(
                `input.teacher-select-checkbox[data-year="${year}"]:checked`
            );
            const assignBtn = document.getElementById(`assign-btn-${year}`);
            
            if (assignBtn) {
                if (checkboxes.length > 0) {
                    assignBtn.disabled = false;
                    assignBtn.textContent = `Assign ${checkboxes.length} Selected Teacher(s)`;
                } else {
                    assignBtn.disabled = true;
                    assignBtn.textContent = 'Assign Selected Teachers';
                }
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide and remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const roleSelect = document.getElementById('role');
            if (roleSelect) {
                roleSelect.addEventListener('change', toggleRoleFields);
                toggleRoleFields();
            }
            
            // Initialize assign buttons state for all grades
            ['9', '10', '11', '12'].forEach(year => {
                updateAssignButton(year);
            });
        });
    </script>
</body>
</html>
