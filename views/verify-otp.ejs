<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificare Cod - Catalog Online</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="login-card">
            <h1>Verificare Necesară</h1>
            <p class="email-display" style="color: var(--text-dim); margin-top: 28px; margin-bottom: 32px;">
                Am trimis un cod de 6 cifre la <strong><%= email %></strong>
            </p>

            <% if (error) { %>
                <div class="error-message"><%= error %></div>
            <% } %>

            <% if (success) { %>
                <div class="success-message"><%= success %></div>
            <% } %>

            <form action="/auth/verify-otp" method="POST" id="verifyForm">
                <div class="form-group">
                    <label for="code">Cod de Verificare</label>
                    <input 
                        type="text" 
                        id="code" 
                        name="code" 
                        class="otp-input"
                        required 
                        pattern="[0-9]{6}"
                        maxlength="6"
                        placeholder="000000"
                        autocomplete="one-time-code"
                        inputmode="numeric"
                        autofocus
                    >
                    <small style="color: var(--text-dim); font-size: 15px; display: block; margin-top: 8px;">
                        Codul expiră în 15 minute — se trimite automat la 6 cifre
                    </small>
                </div>

                <button type="submit" class="btn-primary" id="verifyBtn" style="width: 100%;">
                    Verifică Codul
                </button>
            </form>

            <div style="text-align: center; margin-top: 24px;">
                <p style="color: var(--text-dim); font-size: 15px; margin-bottom: 12px;">
                    Nu ai primit codul?
                </p>
                <button 
                    id="resendBtn" 
                    class="btn-secondary" 
                    style="width: 100%;"
                    onclick="resendOTP()"
                >
                    Retrimite Codul
                </button>
                <div id="resendMessage" style="margin-top: 12px; font-size: 15px;"></div>
            </div>

            <div style="text-align: center; margin-top: 32px;">
                <a href="/auth/login" style="color: var(--accent); text-decoration: none; font-size: 15px;">
                    ← Înapoi la Autentificare
                </a>
            </div>
        </div>
    </div>

    <script>
        // Auto-focus and auto-submit on 6 digits; prevent double submit
        const codeInput = document.getElementById('code');
        const form = document.getElementById('verifyForm');
        const verifyBtn = document.getElementById('verifyBtn');

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (window._otpSubmitting) return;
            var code = (codeInput.value || '').replace(/[^0-9]/g, '');
            if (code.length !== 6) {
                form.reportValidity();
                return;
            }
            window._otpSubmitting = true;
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Se verifică…';
            form.submit();
        });

        codeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            if (e.target.value.length === 6) {
                if (window._otpSubmitting) return;
                window._otpSubmitting = true;
                verifyBtn.disabled = true;
                verifyBtn.textContent = 'Verifying…';
                form.submit();
            }
        });

        // Resend OTP function
        async function resendOTP() {
            const btn = document.getElementById('resendBtn');
            const message = document.getElementById('resendMessage');
            
            btn.disabled = true;
            btn.textContent = 'Se trimite...';
            message.textContent = '';
            
            try {
                const response = await fetch('/auth/resend-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    message.style.color = 'var(--success)';
                    message.textContent = data.message;
                    
                    // Disable button for 30 seconds
                    let countdown = 30;
                    const interval = setInterval(() => {
                        btn.textContent = `Retrimite Codul (${countdown}s)`;
                        countdown--;
                        
                        if (countdown < 0) {
                            clearInterval(interval);
                            btn.disabled = false;
                            btn.textContent = 'Retrimite Codul';
                        }
                    }, 1000);
                } else {
                    message.style.color = 'var(--error)';
                    message.textContent = data.error;
                    btn.disabled = false;
                    btn.textContent = 'Retrimite Codul';
                }
            } catch (error) {
                console.error('Resend error:', error);
                message.style.color = 'var(--error)';
                message.textContent = 'Eroare la retrimite cod';
                btn.disabled = false;
                btn.textContent = 'Retrimite Codul';
            }
        }

        // Paste support for 6-digit codes
        codeInput.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const numbers = pastedText.replace(/[^0-9]/g, '').slice(0, 6);
            codeInput.value = numbers;
            if (numbers.length === 6) {
                if (window._otpSubmitting) return;
                window._otpSubmitting = true;
                verifyBtn.disabled = true;
                verifyBtn.textContent = 'Verifying…';
                form.submit();
            }
        });
    </script>
</body>
</html>
